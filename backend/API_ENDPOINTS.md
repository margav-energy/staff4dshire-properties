# API Endpoints Documentation

## Base URL
`http://localhost:3001/api`

## Job Completions Endpoints

### GET `/job-completions`
Get all job completions with project and staff details.

**Response:**
```json
[
  {
    "id": "uuid",
    "time_entry_id": "uuid",
    "project_id": "uuid",
    "user_id": "uuid",
    "is_completed": true,
    "completion_reason": "string",
    "completion_image_url": "string",
    "status": "pending|approved|rejected|invoiced",
    "approved_by": "uuid",
    "approved_at": "timestamp",
    "rejection_reason": "string",
    "created_at": "timestamp",
    "updated_at": "timestamp",
    "project_name": "string",
    "staff_name": "string"
  }
]
```

### GET `/job-completions/:id`
Get a specific job completion by ID.

### POST `/job-completions`
Create a new job completion.

**Request Body:**
```json
{
  "time_entry_id": "uuid (required)",
  "project_id": "uuid (required)",
  "user_id": "uuid (required)",
  "is_completed": "boolean (required)",
  "completion_reason": "string (required if is_completed is false)",
  "completion_image_url": "string (optional)",
  "status": "pending (optional, default)"
}
```

### PUT `/job-completions/:id/approve`
Approve a job completion.

**Request Body:**
```json
{
  "approved_by": "uuid (required)"
}
```

### PUT `/job-completions/:id/reject`
Reject a job completion.

**Request Body:**
```json
{
  "approved_by": "uuid (required)",
  "rejection_reason": "string (optional)"
}
```

## Invoices Endpoints

### GET `/invoices`
Get all invoices with project and staff details.

**Response:**
```json
[
  {
    "id": "uuid",
    "invoice_number": "string (auto-generated)",
    "project_id": "uuid",
    "time_entry_id": "uuid",
    "job_completion_id": "uuid",
    "staff_id": "uuid",
    "supervisor_id": "uuid",
    "amount": "decimal",
    "hours_worked": "decimal",
    "hourly_rate": "decimal",
    "description": "string",
    "status": "pending|sent|paid|cancelled",
    "is_paid": "boolean",
    "paid_at": "timestamp",
    "paid_by": "uuid",
    "due_date": "date",
    "created_at": "timestamp",
    "updated_at": "timestamp",
    "project_name": "string",
    "project_type": "string",
    "staff_name": "string"
  }
]
```

### GET `/invoices/:id`
Get a specific invoice by ID.

### POST `/invoices`
Create a new invoice.

**Request Body:**
```json
{
  "project_id": "uuid (required)",
  "staff_id": "uuid (required)",
  "amount": "decimal (required)",
  "time_entry_id": "uuid (optional)",
  "job_completion_id": "uuid (optional)",
  "supervisor_id": "uuid (optional)",
  "hours_worked": "decimal (optional)",
  "hourly_rate": "decimal (optional)",
  "description": "string (optional)",
  "status": "pending (optional, default)",
  "due_date": "date (optional)"
}
```

**Note:** Invoice number is auto-generated by database trigger (format: `INV-YYYY-001`).

### PUT `/invoices/:id/pay`
Mark an invoice as paid.

**Request Body:**
```json
{
  "paid_by": "uuid (required)"
}
```

### PUT `/invoices/:id`
Update invoice fields.

**Request Body:** (all fields optional)
```json
{
  "status": "pending|sent|paid|cancelled",
  "amount": "decimal",
  "hours_worked": "decimal",
  "hourly_rate": "decimal",
  "description": "string",
  "due_date": "date",
  "is_paid": "boolean",
  "paid_at": "timestamp",
  "paid_by": "uuid"
}
```

## Incidents Endpoints

### GET `/incidents`
Get all incidents with reporter, project, and assignee details.

**Response:**
```json
[
  {
    "id": "uuid",
    "reporter_id": "uuid",
    "project_id": "uuid",
    "description": "string",
    "photo_path": "string",
    "severity": "low|medium|high|critical",
    "reported_at": "timestamp",
    "location": "string",
    "latitude": "decimal",
    "longitude": "decimal",
    "status": "reported|attending|fixing|tracking|resolved",
    "assigned_to": "uuid",
    "notes": "string",
    "status_updated_at": "timestamp",
    "status_updated_by": "uuid",
    "created_at": "timestamp",
    "updated_at": "timestamp",
    "project_name": "string",
    "reporter_name": "string",
    "assigned_to_name": "string"
  }
]
```

### GET `/incidents/:id`
Get a specific incident by ID.

### POST `/incidents`
Create a new incident.

**Request Body:**
```json
{
  "reporter_id": "uuid (required)",
  "description": "string (required)",
  "project_id": "uuid (optional)",
  "photo_path": "string (optional)",
  "severity": "low|medium|high|critical (optional, default: medium)",
  "location": "string (optional)",
  "latitude": "decimal (optional)",
  "longitude": "decimal (optional)",
  "status": "reported (optional, default)"
}
```

**Note:** `reporter_name` can be sent in the request but is ignored - it's fetched from the users table via JOIN.

### PUT `/incidents/:id`
Update incident status and details.

**Request Body:** (all fields optional)
```json
{
  "status": "reported|attending|fixing|tracking|resolved",
  "assigned_to": "uuid",
  "notes": "string",
  "status_updated_at": "timestamp",
  "status_updated_by": "uuid"
}
```

**Note:** `assigned_to_name` can be sent but is ignored - it's fetched from the users table via JOIN.

## Database Schema Migration

Before using these endpoints, ensure you have run the necessary schema migrations:

1. **Job Completions & Invoices:** Run `backend/schema_job_completion.sql` (after the main `schema.sql`)
2. **Incidents:** Run `backend/schema_incidents.sql` (after the main `schema.sql`)

## Error Responses

All endpoints return errors in the following format:

```json
{
  "error": "Error message description",
  "details": "Additional error details (optional)"
}
```

Common HTTP status codes:
- `200` - Success
- `201` - Created
- `400` - Bad Request (missing/invalid fields)
- `404` - Not Found
- `409` - Conflict (e.g., duplicate job completion for time entry)
- `500` - Internal Server Error

